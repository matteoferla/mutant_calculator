<!DOCTYPE html>
<html>
<!--hosted jQuery library as opposed to local.-->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<style>
    table, th, td {
        border: 1px solid lightgrey;
        border-collapse: collapse;
    }
	input {
	size: 10%;
	width: 50%;
}
</style>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
</head>
<body>

<h1>Bias Calculator</h1>
<h2>Background</h2>
<p>Error prone PCR is a method to create a pool of amplicons with some random errors. This calculator deals with mutational
  biases, not the frequencies of mutations —for that see <a href="http://guinevere.otago.ac.nz/mlrgd/STATS/">Pedel</a>.
  Additionally this calculator has an experimental feature in that an attempt is done to estimate the error in the values.
  This is not done in supplier's manuals as the values are very inaccurate due to the small sample size. The errors are
  calculated using the assumption that a mutation and its complementary are equally likely in light of the double helix
  nature of DNA (<i>e.g.</i> A to G on one strand will result in T to C on the other). For the more complex indicators two
  equations were used. First, the Binaymé rule states that the variance of a sum of averages is the sum of the variances
  of the averages. Second, the variance of a ratio of two averages can be calculated with a first-order Taylor expansion:
  the sum of (the variance of the denominator over the square of the average of the numerator) plus (the square of the
  average of the denominator times the variance of the numerator divided by the forth-power of the average of the
numerator) plus zero (assuming no covariance), all divided by the sample size.</p>
<h2>Input options</h2>
<p>The program can calculate mutation frequencies fromthe list of mutations found and the template sequence, but it can also accept the frequencies directly. If the latter option is desired, scroll down or <a href="#freq">click here</a>.<br>
The <a href="javascript:previde();">'Demo'</a> values are from an actual experiment.</p>
<h2>Sequence</h2>
<p>
  Sequence amplified by mutagenic PCR (all symbols that aren't ATGC, will be discarded):
  <br/>
  <textarea rows="5" id="sequence" style="width:80%"></textarea>
  
</p>
<h2>Mutations found</h2>
<p>The format is each line is a variant sampled. Each line has one or more mutations (in the form: IUPAC
  one-letter nucleobase of original + position (irrelevant) + mutant nucleobase, <i>e.g.</i> A67T) and when there are more
  than one mutation per variant a space should separate them. A wild type sequence can be indicated with 'wt' or 'WT', it
  is not needed for the main calculations and it is used solely for the mean mutations (useful for Pedel).
  <br/>
  <textarea rows="5" id="mutlist"  style="width:80%"></textarea>
  <br/>
</p>
<button onclick="precalcula()">Calculate</button>
<button onclick="previde()">Demo</button>
<button onclick="damno()">Reset</button>
<h2>Average</h2>
<p>The simple average for the mean number of point mutations per sequence (<i>m</i>) is <strong><span id="mutfreq">N/A</span></strong>.<br>
The variance (<strong><span id="mutvar">N/A</span></strong>) should be similar&#8230; if not, consider:<br>
(a) plotting the distribution of point mutations for visual inspection (<strong><span id="mutex">N/A</span></strong>),<br>
(b) fitting the distribution of mutations
to a PCR distribution or a Poisson distribution, and/or<br>
(c) sequencing more variants from the test library.</p>
<a name="freq"></a><h2>Frequencies</h2>
<table width="70%" height="217" border="0">
  <tr>
    <td width="20%">&nbsp;</td>
    <td align="center">To A</td>
    <td align="center"> To T</td>
    <td align="center"> To G</td>
    <td align="center">To C</td>
  </tr>
  <tr>
    <td width="20%">From A</td>
    <td align="center" bgcolor="#CCCCCC"><input type="text" disabled="" id="A2A" value="—"/></td>
    <td align="center" bgcolor="#FFFF99"><input type="text" id="A2T" value="0"/></td>
    <td align="center" bgcolor="#99FFFF"><input id="A2G" type="text" value="0"/></td>
    <td align="center" bgcolor="#FFFF99"><input id="A2C" type="text" value="0"/></td>
  </tr>
  <tr>
    <td width="20%">From T</td>
    <td align="center" bgcolor="#FFFF99"><input type="text" id="T2A" value="0"/></td>
    <td align="center" bgcolor="#CCCCCC"><input type="text" disabled="" id="T2T" value="—"/></td>
    <td align="center" bgcolor="#FFFF99"><input id="T2G" type="text" value="0"/></td>
    <td align="center" bgcolor="#99FF99"><input id="T2C" type="text" value="0"/></td>
  </tr>
  <tr>
    <td width="20%">From G</td>
    <td align="center" bgcolor="#99FFFF"><input type="text" id="G2A" value="0"/></td>
    <td align="center" bgcolor="#FFFF99"><input type="text" id="G2T" value="0"/></td>
    <td align="center" bgcolor="#CCCCCC"><input disabled="" id="G2G" type="text" value="—"/></td>
    <td align="center" bgcolor="#FFFF99"><input id="G2C" type="text" value="0"/></td>
  </tr>
  <tr>
    <td width="20%">From C</td>
    <td align="center" bgcolor="#FFFF99"><input type="text" id="C2A" value="0"/></td>
    <td align="center" bgcolor="#99FF99"><input type="text" id="C2T" value="0"/></td>
    <td align="center" bgcolor="#FFFF99"><input id="C2G" type="text" value="0"/></td>
    <td align="center" bgcolor="#CCCCCC"><input disabled="" id="C2C" type="text" value="—"/></td>
  </tr>
</table>
<p>
<table width="70%" border="0">
  <tr>
    <td width="20%"><p> Colour codes</td>
    <td width="20%" bgcolor="#CCCCCC">Identity</td>
    <td width="20%" bgcolor="#99FFFF">Purine transition</td>
    <td width="20%" bgcolor="#99FF99">Pyrimine transition</td>
    <td width="20%" bgcolor="#FFFF99">Transversion</td>
  </tr>
</table>

<p>&nbsp;</p>
<table width="30%" border="0">
  <tr>
    <td width="147">Proportion of Adenine</td>
    <td width="158"><input type="text" id="sumA" value="25"/>
    % </td>
  </tr>
  <tr>
    <td>Proportion of Thymine</td>
    <td><input type="text" id="sumT" value="25"/>
    % </td>
  </tr>
  <tr>
    <td>Proportion of  Guanine</td>
    <td><input type="text" id="sumG" value="25"/>
    %</td>
  </tr>
  <tr>
    <td><p>Proportion of  Cytosine</p></td>
    <td><input type="text" id="sumC" value="25"/>
    % </td>
  </tr>
</table>
<p>
  <br/>
</p>
<button onclick="calcula()">Calculate</button>
<button onclick="vide()">Demo</button>
<button onclick="damno()">Reset</button>

<br>
<br/>
<!-- OUTPUT-->Sequence-composition–corrected incidence of mutations (%):
<br/>
<table width="50%" id="compNor">
    <tbody>
    <tr>
        <th align="center">From/To</th>
        <th>A</th>
        <th>T</th>
        <th>G</th>
        <th>C</th>
    </tr>
    <tr>
        <td align="center">A</td>
        <td> </td>
        <td> </td>
        <td> </td>
        <td> </td>
    </tr>
    <tr>
        <td align="center">T</td>
        <td> </td>
        <td> </td>
        <td> </td>
        <td> </td>
    </tr>
    <tr>
        <td align="center">G</td>
        <td> </td>
        <td> </td>
        <td> </td>
        <td> </td>
    </tr>
    <tr>
        <td align="center">C</td>
        <td> </td>
        <td> </td>
        <td> </td>
        <td> </td>
    </tr>
    </tbody>
</table>
<br/>
<!-- REAL OUTPUT-->Statistics:
<br/>
<table width="50%" id="fancy">
    <tbody>
    <tr>
        <th>Indicator</th>
        <th>Calculated</th>
        <th>Estimated error</th>
    </tr>
    <tr>
        <td>Ts/Tv</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>AT&#8594;GC/GC&#8594;AT</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>A&#8594;N, T&#8594;N</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>G&#8594;N,C&#8594;N</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>AT&#8594;GC</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>GC&#8594;AT</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>Transitions (%) total

        </td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>&nbsp;·&nbsp;A&#8594;G, T&#8594;C</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>&nbsp;·&nbsp;G&#8594;A, C&#8594;T</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>transversions (%) Total

        </td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>&nbsp;·&nbsp;A&#8594;T, T&#8594;A</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>&nbsp;·&nbsp;A&#8594;C, T&#8594;G</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>&nbsp;·&nbsp;G&#8594;C, C&#8594;G</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>&nbsp;·&nbsp;G&#8594;T, C&#8594;A</td>
        <td></td>
        <td></td>
    </tr>
    </tbody>
</table>
<br/>
<!-- JS FUNCTION -->
<script>
//Not the nicest way, but it's handy
    var A = 0;
    var T = 1;
    var G = 2;
    var C = 3;

    function variance(values) {
        var avg = average(values);
        var squareDiffs = values.map(function (value) {
            var diff = value - avg;
            return diff * diff;
        });
        return average(squareDiffs);
    }

    function average(data) {
        var sum = data.reduce(function (sum, value) {
            return sum + value;
        }, 0);
        return sum / data.length;
    }

    function rd(x) {
        return Math.round(x * 10) / 10;
    }

    function transSum(m, x, y, w, z) {
        var s = m[x][y] + m[w][z];
        var v = variance([m[x][y], m[w][z]]);
        var d = Math.sqrt(v / 2);
        return [s, d, v];
    }

    function varRatio(mx, vx, my, vy, n) {
        var mxsq = Math.pow(mx, 2);
        var mysq = Math.pow(my, 2);
        var mxqd = Math.pow(mx, 4);
        return Math.abs(vy / mxsq + mysq * vx / mxqd) / n; //covariance set to 0.
    }

    function qV(m, x, y) {
        return variance([m[x][y], m[y][x]]);
    }

    function precalcula() {
        ablue();
        //parse sequence
        var seq = document.getElementById("sequence").value.replace(/[^ATGC]/g, '').split('');
        var freq = {'A': 0, 'C': 0, 'G': 0, 'T': 0};
        var bases = ['A', 'C', 'G', 'T'];
        for (var x = 0; x < seq.length; x++) {
            freq[seq[x]]++;
        }
        for (var x = 0; x < 4; x++) {
            document.getElementById("sum" + bases[x]).value = Math.round(freq[bases[x]] / seq.length * 1000) / 10;
        }
        //parse mutants
        var tally = [];
        var raw_list = document.getElementById("mutlist").value.split(/\r\n|\r|\n/g);
        for (var i = 0; i < raw_list.length; i++) {
            if (!raw_list[i].match(/\w/)) {
                continue;
            }
            var variant = raw_list[i].split(/\W/g);
            if ((variant[0] == 'WT') || (variant[0] == 'wt')) {
                tally[i] = 0;
                continue;
            }
            tally[i] = variant.length;
            for (var j = 0; j < variant.length; j++) {
                document.getElementById(variant[j].substr(0, 1) + "2" + variant[j].substr(-1, 1)).value++;
            }
        }
        document.getElementById('mutfreq').innerHTML = Math.round(average(tally) * 10) / 10;
        document.getElementById('mutvar').innerHTML = Math.round(variance(tally) * 10) / 10;
		document.getElementById('mutex').innerHTML = tally;
		calcula();
    }
	
	function damno() {
		ablue();
		document.getElementById("mutlist").value=" ";
		document.getElementById("sequence").value=" ";
		}
		
    function ablue() {
        var bases = ['A', 'T', 'G', 'C'];
        for (var x = 0; x < bases.length; x++) {
            for (var y = 0; y < bases.length; y++) {
                if (x == y) {
                    continue;
                }
                document.getElementById(bases[x] + "2" + bases[y]).value = 0;
            }
            document.getElementById("sum" + bases[x]).value = 25;
        }
		calcula(); //blank by errors...
		document.getElementById("mutfreq").innerHTML="N/A";
		document.getElementById("mutex").innerHTML="N/A";
		document.getElementById("mutvar").innerHTML="N/A";
    }

    function vide() {
        document.getElementById("A2T").value = 0;
        document.getElementById("A2C").value = 2;
        document.getElementById("A2G").value = 10;
        document.getElementById("T2A").value = 2;
        document.getElementById("T2G").value = 0;
        document.getElementById("T2C").value = 2;
        document.getElementById("G2A").value = 2;
        document.getElementById("G2T").value = 2;
        document.getElementById("G2C").value = 1;
        document.getElementById("C2A").value = 2;
        document.getElementById("C2T").value = 8;
        document.getElementById("C2G").value = 0;
        document.getElementById("sumA").value = 30;
        document.getElementById("sumT").value = 21;
        document.getElementById("sumG").value = 26;
        document.getElementById("sumC").value = 23;
		calcula();
	}
	
	function previde() {
		document.getElementById("sequence").value="MNTDDILFSYGEEDIPLKALSFPIFETTNFYFDSFDEMSKALRNGDYEFVYKRGSNPTTRLVEKKLAALEECEDARLVASGMSAISLSILHFLSSGDHVVCVDEAYSWAKKFFNYLSKKFDIEVSYVPPDAERIVEAITKKTKLIYLESPTSMRMKVIDIRKVTEAAGELKIKTVIDNTWASPIFQKPKLLGVDVVVHSATKYISGHGDVMAGVIAGDVEDMKNIFVDEYKNIGPVLSPIEAWLILRGLRTLELRMKKHYENALVVSDFLMDHPKVLEVNYPMNPRSPQYELASSQMSGGSGLMSFRLKTDSAEKVKEFVESLRVFRMAVSWGSHENLVVPRVAYGDCPKKDVNLIRIHVGLGDPEKLVEDLDQALKKI";
		document.getElementById("mutlist").value="G286A T306C A687T T880C\nWT\nWT\nC372T A923G\nG832A\nA650C\nA720C\nC449A A556G A814G A853G C826T C1059T\nG793A\nA1048G\nG726T\nG982C\nC53T G678T T798A\nA224T A447G A586T C964T\nA185T\nT860A\nA979T A1005T\nC453T\nWT";
		precalcula();
    }
		

    function calcula() {

        //Get data
        var Amuts = [0, document.getElementById("A2T").value, document.getElementById("A2G").value, document.getElementById("A2C").value];
        var Tmuts = [document.getElementById("T2A").value, 0, document.getElementById("T2G").value, document.getElementById("T2C").value];
        var Gmuts = [document.getElementById("G2A").value, document.getElementById("G2T").value, 0, document.getElementById("G2C").value];
        var Cmuts = [document.getElementById("C2A").value, document.getElementById("C2T").value, document.getElementById("C2G").value, 0];
        var muts = [Amuts, Tmuts, Gmuts, Cmuts];
        var dis = [document.getElementById("sumA").value, document.getElementById("sumT").value, document.getElementById("sumG").value, document.getElementById("sumC").value];

        //Normalise
        var summa = 0;
        for (i = 0; i < 4; i++) {
            for (j = 0; j < 4; j++) {
                muts[i][j] /= dis[i];
                summa += muts[i][j];
            }
        }
        summa /= 100; // /100 --> %
        for (i = 0; i < 4; i++) {
            for (j = 0; j < 4; j++) {
                muts[i][j] /= summa;
                document.getElementById("compNor").rows[i + 1].cells[j + 1].innerHTML = rd(muts[i][j]);
            }
        }

        //Canculate fancy table

        //A>G + T>C
        var ts1 = transSum(muts, A, G, T, C);

        //G>A + C>T
        var ts2 = transSum(muts, G, A, C, T);

        //Ts total
        var tsT = [];
        tsT[0] = ts1[0] + ts2[0];
        tsT[2] = ts1[2] + ts2[2]; //Biename for variance.
        tsT[1] = Math.sqrt(tsT[2] / 2); // n =2

        //A>T + T>A
        var tvW = transSum(muts, A, T, T, A);

        //A&#8594;C, T&#8594;G
        var tvN1 = transSum(muts, A, C, T, G);

        // G&#8594;C, C&#8594;G
        var tvS = transSum(muts, G, C, C, G);

        // G&#8594;T, C&#8594;A
        var tvN2 = transSum(muts, G, T, C, A);

        //Tv total
        var tvT = [];
        tvT[0] = tvW[0] + tvS[0] + tvN1[0] + tvN2[0];
        tvT[2] = tvW[2] + tvS[2] + tvN1[2] + tvN2[2]; //Biename for variance.
        tvT[1] = Math.sqrt(tvT[2] / 4); // n =4

        //Ts/Tv
        var tt = [];
        tt[0] = tsT[0] / tvT[0];
        tt[2] = varRatio(tsT[0], tsT[2], tvT[0], tvT[2], 2); // Taylor w n =2
        tt[1] = Math.sqrt(tt[2] / 2);

        //AT&#8594;GC
        var ws = [];
        ws[0] = muts[A][G] + muts[A][C] + muts[T][G] + muts[T][C];
        ws[2] = variance([muts[A][G], muts[T][C]]) + variance([muts[A][C], muts[T][G]]);
        ws[1] = Math.sqrt(ws[2] / 2);

        //GC&#8594;AT
        var sw = [];
        sw[0] = muts[G][A] + muts[G][T] + muts[C][A] + muts[C][T];
        sw[2] = variance([muts[G][A], muts[C][T]]) + variance([muts[G][T], muts[C][A]]);
        sw[1] = Math.sqrt(sw[2] / 2);

        //AT&#8594;GC/GC&#8594;AT
        var wssw = [];
        wssw[0] = ws[0] / sw[0];
        wssw[2] = varRatio(ws[0], ws[2], sw[0], sw[2], 2);
        wssw[1] = Math.sqrt(wssw[2] / 2);

        ////AT&#8594;GC/GC&#8594;AT
        var wssw = [];
        wssw[0] = ws[0] / sw[0];
        wssw[2] = varRatio(ws[0], ws[2], sw[0], sw[2], 2);
        wssw[1] = Math.sqrt(wssw[2] / 2);

        //A&#8594;N, T&#8594;N
        var wn = [];
        wn[0] = muts[A][T] + muts[A][G] + muts[A][C] + muts[T][A] + muts[T][G] + muts[T][C];
        wn[2] = qV(muts, A, T) + qV(muts, A, G) + qV(muts, A, C) + qV(muts, T, A) + qV(muts, T, G) + qV(muts, T, C);
        wn[1] = Math.sqrt(wn[2] / 6);

        //G&#8594;N, C&#8594;N
        var sn = [];
        sn[0] = muts[G][A] + muts[G][T] + muts[G][C] + muts[C][A] + muts[C][G] + muts[C][T];
        sn[2] = qV(muts, G, A) + qV(muts, G, T) + qV(muts, G, C) + qV(muts, C, A) + qV(muts, C, G) + qV(muts, C, T);
        sn[1] = Math.sqrt(wn[2] / 6);

        var fancy = document.getElementById("fancy").rows;
        fancy[1].cells[1].innerHTML = rd(tt[0]);
        fancy[1].cells[2].innerHTML = rd(tt[1]);
        fancy[2].cells[1].innerHTML = rd(wssw[0]);
        fancy[2].cells[2].innerHTML = rd(wssw[1]);
        fancy[3].cells[1].innerHTML = rd(wn[0]) + " %";
        fancy[3].cells[2].innerHTML = rd(wn[1]) + " %";
        fancy[4].cells[1].innerHTML = rd(sn[0]) + " %";
        fancy[4].cells[2].innerHTML = rd(sn[1]) + " %";
        fancy[5].cells[1].innerHTML = rd(ws[0]) + " %";
        fancy[5].cells[2].innerHTML = rd(ws[1]) + " %";
        fancy[6].cells[1].innerHTML = rd(sw[0]) + " %";
        fancy[6].cells[2].innerHTML = rd(sw[1]) + " %";
        fancy[7].cells[1].innerHTML = rd(tsT[0]) + " %";
        fancy[7].cells[2].innerHTML = rd(tsT[1]) + " %";
        fancy[8].cells[1].innerHTML = rd(ts1[0]) + " %";
        fancy[8].cells[2].innerHTML = rd(ts1[1]) + " %";
        fancy[9].cells[1].innerHTML = rd(ts2[0]) + " %";
        fancy[9].cells[2].innerHTML = rd(ts2[1]) + " %";
        fancy[10].cells[1].innerHTML = rd(tvT[0]) + " %";
        fancy[10].cells[2].innerHTML = rd(tvT[1]) + " %";
        fancy[11].cells[1].innerHTML = rd(tvW[0]) + " %";
        fancy[11].cells[2].innerHTML = rd(tvW[1]) + " %";
        fancy[12].cells[1].innerHTML = rd(tvN1[0]) + " %";
        fancy[12].cells[2].innerHTML = rd(tvN1[1]) + " %";
        fancy[13].cells[1].innerHTML = rd(tvS[0]) + " %";
        fancy[13].cells[2].innerHTML = rd(tvS[1]) + " %";
        fancy[14].cells[1].innerHTML = rd(tvN2[0]) + " %";
        fancy[14].cells[2].innerHTML = rd(tvN2[1]) + " %";
    }
</script>
</body>
</html>


