<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Mutation calculator</title>
<!--hosted jQuery library as opposed to local.-->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="mutationalBias.js"></script>
<script src="https://jmat.googlecode.com/git/jmat.js"></script>
<style>
    table, th, td {
        border: 1px solid lightgrey;
        border-collapse: collapse;
		text-align: center;
    }
	.clearless{border:none #FFF; padding:0;}
	input {
	size: 10%;
	width: 50%;
}
</style>
</head>
<body>
<h1>Bias Calculator</h1>
<h2>Background</h2>
<p>Error prone PCR is a method to create a pool of amplicons with some random errors. This calculator deals with mutational
  biases, not the frequencies of mutations —for that see <a href="http://guinevere.otago.ac.nz/mlrgd/STATS/">Pedel</a>.
  Additionally this calculator has an experimental feature in that an attempt is done to estimate the error in the values.
  This is not done in supplier's manuals as the values are very inaccurate due to the small sample size. The errors are
  calculated using the assumption that a mutation and its complementary are equally likely in light of the double helix
  nature of DNA (<i>e.g.</i> A to G on one strand will result in T to C on the other). For the more complex indicators two
  equations were used. First, the Binaymé rule states that the variance of a sum of averages is the sum of the variances
  of the averages. Second, the variance of a ratio of two averages can be calculated with a first-order Taylor expansion:
  the sum of (the variance of the denominator over the square of the average of the numerator) plus (the square of the
  average of the denominator times the variance of the numerator divided by the forth-power of the average of the
numerator) plus zero (assuming no covariance), all divided by the sample size.</p>
<h2>Input options</h2>
<p>The program can calculate mutation frequencies from the list of mutations found and the template sequence, but it can also accept the frequencies directly. <span id="optionality">If the latter option is desired,  <a href="#" onClick="Btn_FrqIn();">click here</a>.</span><br>
The <a href="javascript:Btn_demo();">'Demo'</a> values are from an actual experiment &mdash;It is not cherrypicked, in fact it actually has a jackpot (high mutation sequence) that messes up the variance.</p>
<div id="seqSect">
<h2>Sequence</h2>
<p>Sequence amplified by mutagenic PCR (all symbols that aren't ATGC, will be discarded):
  <br/>
  <textarea name="sequence" rows="5" id="sequence" style="width:80%"></textarea>
  
</p>
<h2>Mutations found</h2>
<p>The format is each line is a variant sampled. Each line has one or more mutations (in the form: IUPAC
  one-letter nucleobase of original + position (irrelevant) + mutant nucleobase, <i>e.g.</i> A67T) and when there are more
  than one mutation per variant a space should separate them. A wild type sequence can be indicated with 'wt' or 'WT', it
  is not needed for the main calculations and it is used solely for the mutational frequency &mdash;useful for Pedel.
  <br/>
  <textarea name="baseList" rows="5" id="baseList"  style="width:80%"></textarea>
  <br/>
</p>
<button onclick="Btn_calcFreq()">Calculate</button>
<button onclick="Btn_demo()">Demo</button>
<button onclick="Btn_blank(1)">Reset</button>
</div><div id="avgSect">
<h2>Mutational frequency</h2>
<p>The simplest estimate of the frequency of mutations per sequence is the average of the point mutations per sequence (<i>m</i>), however due to the small sample size this may be off. The distribution of number of mutations per sequence follows a PCR distribution, which can <span style="border-bottom: 1px dotted" title="converging as the number of PCR cycles tends to infinity">approximated</span> with a Poisson distribution  (<span style="border-bottom: 1px dotted" title="Sun F. (1995). The polymerase chain reaction and branching processes, J. Comput. Biol., 2, 63-86.">Sun, 1995</span>). In the <span style="border-bottom: 1px dotted" title="and the former at n_{PCR} = &#8734;  as the variance is equal to the mean *plus* the ratio of square of the mean over the product of n_{PCR} times efficiency.">latter</span>, the mean and the variance are the same (λ &mdash;unrelated to PCR efficiency&mdash;). The <em>sample</em> average and variance may differ, especially at low sampling. The number to trust the most is the λ<sub>Poisson</sub>.<br>
  The average
is <strong><span id="freqMean">N/A</span></strong>.<br>
  The sample variance is <strong><span id="freqVar">N/A</span></strong>.<br>  
  The λ<sub>Poisson</sub>  is <strong><span id="freqλ">N/A</span></strong>.<br>
   Due to sampling the three values might be quite different&#8230; If so consider:<br>
  (a) plotting the distribution of point mutations for visual inspection,<br>
  (b) fitting the distribution of mutations
  to a PCR distribution (n PCR cycles needed), and/or<br>
  (c) sequencing more variants from the test library.<br>
  Values for further analysis: <strong><span id="freqList">N/A</span></strong></p>
</div><div id="freqSect"><!--JS controlled visibility-->
<h2>Frequencies</h2>
<p>
<table width="50%" border="0" id="mutTable_raw">
  <thead>
  <tr>
    <th width="20%">To/From</th>
    <th width="20%">A</th>
    <th width="20%">T</th>
    <th width="20%">G</th>
    <th width="20%">C</th>
  </tr>
  </thead>
  <tbody>
  <tr>
    <th>A</th>
    <td bgcolor="#CCCCCC"><input type="text" disabled="" id="A2A" value="—"/></td>
    <td bgcolor="#FFFF99" ><input type="text" id="A2T" value="0"/></td>
    <td bgcolor="#99FFFF"><input id="A2G" type="text" value="0"/></td>
    <td bgcolor="#FFFF99"><input id="A2C" type="text" value="0"/></td>
  </tr>
  <tr>
    <th width="20%">T</th>
    <td width="20%" bgcolor="#FFFF99"><input type="text" id="T2A" value="0"/></td>
    <td bgcolor="#CCCCCC"><input type="text" disabled="" id="T2T" value="—"/></td>
    <td bgcolor="#FFFF99"><input id="T2G" type="text" value="0"/></td>
    <td bgcolor="#99FF99"><input id="T2C" type="text" value="0"/></td>
  </tr>
  <tr>
    <th width="20%">G</th>
    <td width="20%" bgcolor="#99FFFF"><input type="text" id="G2A" value="0"/></td>
    <td bgcolor="#FFFF99"><input type="text" id="G2T" value="0"/></td>
    <td bgcolor="#CCCCCC"><input disabled="" id="G2G" type="text" value="—"/></td>
    <td bgcolor="#FFFF99"><input id="G2C" type="text" value="0"/></td>
  </tr>
  <tr>
    <td width="20%">C</td>
    <td width="20%" bgcolor="#FFFF99"><input type="text" id="C2A" value="0"/></td>
    <td bgcolor="#99FF99"><input type="text" id="C2T" value="0"/></td>
    <td bgcolor="#FFFF99"><input id="C2G" type="text" value="0"/></td>
    <td bgcolor="#CCCCCC"><input disabled="" id="C2C" type="text" value="—"/></td>
  </tr>
  </tbody>
</table>
</p>
<p><table width="50%" border="0">
  <tr>
    <th width="20%">Colour codes</th>
    <td width="20%" bgcolor="#CCCCCC">Identity</td>
    <td width="20%" bgcolor="#99FFFF">Purine transition</td>
    <td width="20%" bgcolor="#99FF99">Pyrimine transition</td>
    <td width="20%" bgcolor="#FFFF99">Transversion</td>
  </tr>
</table></p>
<p>
<table width="30%" class="clearless">
  <tr>
    <th width="160" class="clearless">Proportion of Adenine</th>
    <td class="clearless"><input type="text" id="sumA" value="25"/>
    % </td>
  </tr>
  <tr>
    <th class="clearless">Proportion of Thymine</th>
    <td class="clearless"><input type="text" id="sumT" value="25"/>
    % </td>
  </tr>
  <tr>
    <th class="clearless">Proportion of  Guanine</th>
    <td class="clearless"><input type="text" id="sumG" value="25"/>
    %</td>
  </tr>
  <tr>
    <th class="clearless">Proportion of  Cytosine</th>
    <td class="clearless"><input type="text" id="sumC" value="25"/>
    % </td>
  </tr>
</table>
</p>
<p>
<button onclick="Btn_calcBias()">Calculate</button>
<button onclick="Btn_demo()">Demo</button>
<button onclick="Btn_blank(2)">Reset</button>
</p></div>
<div id="biasSect"><!--JS controlled visibility-->
<h2>Corrected mutation incidence</h2>
<p>Sequence-composition–corrected incidence of mutations (%):</p>
<p>
<table width="50%" id="mutTable">
<thead>
    <tr>
        <th width="20%">From/To</th>
        <th width="20%">A</th>
        <th width="20%">T</th>
        <th width="20%">G</th>
        <th width="20%">C</th>
    </tr>
</thead>
    <tbody>
    <tr>
        <th>A</th>
        <td bgcolor="#CCCCCC"> </td>
        <td bgcolor="#FFFF99"> </td>
        <td bgcolor="#99FFFF"> </td>
        <td bgcolor="#FFFF99"> </td>
    </tr>
    <tr>
        <th>T</th>
        <td bgcolor="#FFFF99"> </td>
        <td bgcolor="#CCCCCC"> </td>
        <td bgcolor="#FFFF99"> </td>
        <td bgcolor="#99FF99"> </td>
    </tr>
    <tr>
        <th>G</th>
        <td bgcolor="#99FFFF"> </td>
        <td bgcolor="#FFFF99"> </td>
        <td bgcolor="#CCCCCC"> </td>
        <td bgcolor="#FFFF99"> </td>
    </tr>
    <tr>
        <th>C</th>
        <td bgcolor="#FFFF99"> </td>
        <td bgcolor="#99FF99"> </td>
        <td bgcolor="#FFFF99"> </td>
        <td bgcolor="#CCCCCC"> </td>
    </tr>
    </tbody>
</table>
</p>
<h2>Statistics</h2>
<p>
<table width="50%" id="biasTable">
<thead>
<tr>
        <th>Indicator</th>
        <th>Calculated</th>
        <th>Estimated error</th>
    </tr>
</thead>
    <tbody>
    <tr>
        <th>Ts/Tv</th>
      <td id='TsOverTv'></td>
      <td id='TsOverTv_error'></td>
    </tr>
    <tr>
        <th>AT&#8594;GC/GC&#8594;AT</th>
      <td id='W2SOverS2W'></td>
      <td id='W2SOverS2W_error'></td>
    </tr>
    <tr>
        <th>A&#8594;N, T&#8594;N (%)</th>
      <td id="W2N"></td>
      <td id="W2N_error"></td>
    </tr>
    <tr>
        <th>G&#8594;N,C&#8594;N (%)</th>
      <td id="S2N"></td>
      <td id="S2N_error"></td>
    </tr>
    <tr>
        <th>AT&#8594;GC (%)</th>
      <td id="W2S"></td>
      <td id="W2S_error"></td>
    </tr>
    <tr>
        <th>GC&#8594;AT (%)</th>
      <td id="S2W"></td>
      <td id="S2W_error"></td>
    </tr>
    <tr>
        <th>Transitions (%) total
        </th>
      <td id="ΣTs"></td>
      <td id="ΣTs_error"></td>
    </tr>
    <tr>
        <th>A&#8594;G, T&#8594;C (%)</th>
      <td id="Ts1"></td>
      <td id="Ts1_error"></td>
    </tr>
    <tr>
        <th>G&#8594;A, C&#8594;T (%)</th>
      <td id="Ts2"></td>
      <td id="Ts2_error"></td>
    </tr>
    <tr>
        <th>transversions (%) Total

        </th>
      <td id="ΣTs"></td>
      <td id="ΣTs_error"></td>
    </tr>
    <tr>
        <th>A&#8594;T, T&#8594;A (%)</th>
      <td id="TvW"></td>
      <td id="TvW_error"></td>
    </tr>
    <tr>
        <th>A&#8594;C, T&#8594;G (%)</th>
      <td id="TvN1"></td>
      <td id="TvN1_error"></td>
    </tr>
    <tr>
        <th>G&#8594;C, C&#8594;G (%)</th>
      <td id="TvS"></td>
      <td id="TvS_error"></td>
    </tr>
    <tr>
        <th>G&#8594;T, C&#8594;A (%)</th>
      <td id="TvN2"></td>
      <td id="TvN2_error"></td>
    </tr>
    </tbody>
</table>
</p>
</div>

<br/>
<script>
$( document ).ready(function() {
		$("#seqSect").show();
		$("#avgSect").hide();
		$("#freqSect").hide();
		$("#biasSect").hide();
		var mutball=mutagen();
       var queries = window.location.search.substring(1).split("&");
       for (var i=0;i<queries.length;i++) {
		   var pair=queries[i].split("=");
		   eval("mutball."+pair[0]+"='"+pair[1].replace("%20"," ").replace("%0A","\\n")+"'");}
	   commit(mutball);
	});

//**************************************************
//Not the nicest way, but it's handy way to avoid a needless obj and quotes.
// Unfortunately two different approaches to fill tables were inadvertedly taken.
//Globals.
    var A = 0;
    var T = 1;
    var G = 2;
    var C = 3;
	var bases = ['A', 'C', 'G', 'T'];
	var ways=[];
	for (b in bases) {
		for (d in bases) {
		ways.push(bases[b]+"2"+bases[d]);
	}
	}
//**************************************************
//Button wrappers.
//They don't touch any Doc elements. Only the mutball does via it's read() and commit() methods. This was done for portability. However, the attributes are document ids too. If one were to change them the read and commit methods need changing.

	function Btn_blank(n) {
		commit();
		$("#seqSect").hide();
		$("#avgSect").hide();
		$("#freqSect").hide();
		$("#biasSect").hide();	
		if (n ==1) {$("#seqSect").show();} 
		else if (n==2)  {$("#freqSect").show();} 
		
		return false;
		}

	function Btn_demo() {
		var mutball=mutagen();
		mutball.sequence="ATGAACACAGACGACATTCTGTTTTCTTACGGAGAAGAAGACATTCCTTTGAAGGCGCTGTCGTTTCCCATCTTCGAAACGACGAATTTCTACTTCGACAGTTTCGACGAGATGTCGAAAGCCCTCAGAAACGGAGACTACGAATTCGTTTACAAAAGAGGAAGTAATCCCACAACGAGACTGGTGGAGAAGAAACTCGCAGCGCTTGAAGAGTGTGAAGATGCCCGCCTCGTTGCCTCTGGAATGAGCGCCATTTCGCTTTCCATCCTTCATTTCCTCAGCTCGGGAGACCACGTCGTGTGTGTGGACGAGGCTTACTCCTGGGCGAAAAAGTTCTTCAACTACCTTTCAAAGAAGTTCGATATAGAAGTCAGCTACGTTCCTCCCGACGCGGAAAGAATAGTCGAAGCCATCACGAAGAAGACGAAGCTCATCTACCTCGAAAGTCCCACGAGTATGAGAATGAAAGTGATCGATATAAGAAAGGTCACAGAAGCGGCAGGAGAACTCAAGATAAAAACCGTCATAGACAACACCTGGGCGTCGCCGATCTTTCAAAAACCAAAGCTTCTGGGAGTGGATGTGGTGGTCCACTCTGCGACGAAGTACATCTCAGGACACGGAGACGTGATGGCAGGAGTGATCGCAGGAGACGTCGAAGATATGAAGAACATCTTCGTGGATGAATACAAAAACATCGGACCGGTTCTCTCGCCCATAGAAGCCTGGCTCATCTTGAGAGGTCTTAGAACGCTGGAACTCCGTATGAAAAAGCACTACGAAAACGCTCTTGTGGTGTCTGACTTCCTCATGGATCACCCGAAGGTCCTCGAGGTGAACTACCCGATGAATCCAAGATCACCGCAGTACGAACTCGCTTCCTCTCAGATGAGCGGTGGCTCAGGACTGATGAGCTTCAGGCTGAAAACGGACAGCGCAGAGAAAGTCAAAGAGTTCGTCGAAAGTCTGAGGGTTTTCAGGATGGCTGTGAGCTGGGGAAGTCACGAGAACCTTGTTGTTCCAAGGGTGGCTTATGGAGACTGCCCGAAAAAAGACGTGAACCTGATAAGAATCCATGTGGGTCTCGGAGATCCAGAAAAGCTCGTGGAAGATCTGGATCAGGCACTCAAAAAGATTTAA";
		mutball.baseList="G286A T306C A687T T880C\nWT\nWT\nC372T A923G\nG832A\nA650C\nA720C\nC449A A556G A814G A853G C826T C1059T\nG793A\nA1048G\nG726T\nG982C\nC53T G678T T798A\nA224T A447G A586T C964T\nA185T\nT860A\nA979T A1005T\nC453T\nWT";
		mutball=calcFreq(mutball);
		commit(mutball); //Not redundant due to the div show and hide.
		mutball=calcBias(mutball);
		commit(mutball);
		return false;
		}
		
	function Btn_calcFreq() {
		 var mutball=read(["sequence","baseList"]);
		 mutball=calcFreq(mutball);
		 commit(mutball);
		 mutball=calcBias(mutball);
		commit(mutball);
		return false;
		}
		
	function Btn_calcBias(){
		mutball = read(ways.concat(["sumA","sumT","sumG","sumC"]));
		commit(mutball);
		return false;
	}
	
	function Btn_FrqIn() {
		//$("#seqSect").css("visibility", "collapse");
		$("#seqSect").hide();
		$("#avgSect").hide();
		$("#freqSect").show();
		$("#biasSect").hide();		
		$("#optionality").html('If the former option is desired,  <a href="#" onClick="Btn_SeqIn();">click here</a>.');
		return false;
		}
		
		function Btn_SeqIn() {
		//$("#seqSect").css("visibility", "collapse");
		$("#seqSect").show();
		$("#avgSect").hide();
		$("#freqSect").hide();
		$("#biasSect").hide();	
		$("#optionality").html('If the latter option is desired,  <a href="#" onClick="Btn_FrqIn();">click here</a>.');
		return false;
		}
		
//Interactions of Mutball and the HTML
function commit(mutball) {
	mutball= mutball || mutagen();
				if (mutball.source=='freq') {$("#freqSect").show(); $("#avgSect").show();}
				if (mutball.source=='Bias') {$("#biasSect").show();} //id="biasSect" style=
				for (handle in mutball) {
					if (handle =='mutTable') {
						for (i = 0; i < 4; i++) {
            				for (j = 0; j < 4; j++) {
								$("#mutTable tbody tr:eq("+i+") td:eq("+j+")").html(rd(mutball.mutTable[i][j]));
								}
						} 
						}
						//it will try changing non existant sections, but that's okay
						else{$("#"+handle).val(mutball[handle]); $("#"+handle).text(mutball[handle]);}
					}}
					
function read (handles) {
				var mutball=mutagen();
				for (h in handles) {mutball[handles[h]]=$("#"+handles[h]).val();}
				return mutball;}
				

</script>
</body>
</html>
